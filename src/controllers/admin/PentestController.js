const express = require('express');
const router = express.Router();
const projectModel = require('../admin/../../database/schemas/project');
const pentestModel = require('../admin/../../database/schemas/pentest');
const findingModel = require('../admin/../../database/schemas/finding');


//add check
//add validationError
//For now the fields are the same as for project but this will change later
createPentest = async (req, res) => {
 
    //const { title,leadConsultant,scope,startDate,endDate,specialRequirements,executiveSummary } = req.body;
    const findings = req.body.findings;
    const projectName = Object.values(req.params);
    const project = await projectModel.findOne({'title': projectName})

    const newPentest = new pentestModel({
      title: project.title,
      leadConsultant: project.leadConsultant,
      scope: project.scope,
      startDate: project.startDate,
      endDate: project.endDate,
      specialRequirements: project.specialRequirements,
      executiveSummary: project.executiveSummary,
      project: project._id,
    });

    await findings.forEach(element => {
        const newFinding = new findingModel({
        title: element.title,
        vulnDescription: element.vulnDescription,
        findingDescription: element.findingDescription,
        imapct: element.imapct,
        execProbability: element.execProbability,
        severity: element.severity,
        category: element.category,
        screenshots: element.screenshots, ///base64 encoded value or better s3 bucket link
        additionalComments: element.additionalComments,
        tags: element.tags,
        assets: element.assets
        //mitigation: mitigation
        })
        savedFinding = newFinding.save();
    });
  
    savedPentest = await newPentest.save();
    res.send(savedPentest)


};


module.exports = { createPentest };